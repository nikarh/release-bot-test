name: Show PR Info on Merge

on:
  push:
    branches:
      - main

jobs:
  pr-info:
    runs-on: ubuntu-latest
    steps:
      - name: Detect PR merge and extract info
        id: detect_pr
        uses: actions/github-script@v8
        with:
          script: |
            const commitMsg = context.payload.head_commit?.message || "";
            const commitSha = context.sha;
            const prMatch = commitMsg.match(/^Merge pull request #(\d+) from .*/);

            if (!prMatch) {
              return { pull_number: "" };
            }

            const prNumber = prMatch[1];
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            const isRelease = pr.labels.some(label => label.name === "release");

            if (pr.data.merge_commit_sha === commitSha && isRelease) {
              return {
                pull_number: prNumber,
                title: pr.data.title,
                body: pr.data.body || ""
              };
            } else {
              return { pull_number: "" };
            }
      - name: Echo PR info
        run: |
          if [[ "${{ steps.detect_pr.outputs.pull_number }}" != "" ]]; then
            echo "${{ steps.detect_pr.outputs.title }}"
            echo "${{ steps.detect_pr.outputs.body }}"
          else
            echo "Not a PR merge"
          fi
